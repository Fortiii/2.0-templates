<!--

CONVENTIONS:

* ERRORS: Add .has-error to the div.form-group
* Error messages are div.alert.alert-danger

* SUCCESS: Add .has-success to the div.form-group
* Success messages are div.alert.alert-success

* Info messages are div.alert.alert-info


TODO:
* Change all .alert to labels for inputs?

-->

{% block checkout %}
{# do no remove this outer div;
   the data-fc-id="block-checkout" element
   must not be the most outer element #}
<div>
<div data-fc-id="block-checkout">
<section data-fc-error-notifier><h3 data-fc-notifier-text></h3></section>
{# BEGIN CHECKOUT TWIG TEMPLATE #}
<div class="container">
<div id="fc-checkout-container" class="row panel">




{% block sidebar %}
<div class="col-sm-4 col-sm-push-8 fc-sidebar">

    {% block logo %}
    {% if config.store_logo_url %}
    <img id="fc-logo" src="{{ config.cache_path }}{{ config.store_logo_url }}" class="img-responsive" alt="{{ store_name }}">
    {% else %}
    <h1 id="fc-logotype">{{ config.store_name }}</h1>
    {% endif %}
    {% endblock logo %}

    <div data-fc-container="cart">
        {% include 'cart.inc.twig' %}
    </div>

</div><!-- #sidebar -->
{% endblock sidebar %}


<div id="fc-main" class="col-sm-8 col-md-8 xcol-md-offset-1 col-sm-pull-4">

    {% block checkout_errors %}
        {% include 'errors.inc.twig' %}
    {% endblock checkout_errors %}

    {% block noscript_warning %}
    <noscript>
        <div id="fc-noscript-errors" class="alert alert-danger">
            <h2>{{ config.lang.checkout_warning|raw }}</h2>
            <p>{{ config.lang.checkout_no_javascript_message|raw }}</p>
        </div><!-- #fc-noscript-errors -->
    </noscript>
    {% endblock noscript_warning %}


    <form method="post" class="form-horizontal" data-fc-id="checkout-form" action="https://{{ config.store_domain }}{{ config.post_url }}">

        <div data-fc-id="required-hidden-fields">
        {% block required_hidden_fields %}
            <input type="hidden" id="ThisAction" name="ThisAction" value="checkout" />
            <input type="hidden" id="customer_id" name="customer_id" value="{{ customer_id_encoded }}" />
            <input type="hidden" id="{{ session_name }}" name="{{ session_name }}" value="{{ session_id }}" />
            <input type="hidden" id="is_anonymous" name="is_anonymous" value="{{ is_anonymous ? 1 : 0 }}" />
            <input type="hidden" id="anonymous_checkout_selected" name="anonymous_checkout_selected" value="{{ anonymous_checkout_selected ? 1 : 0 }}" />
            <input type="hidden" id="email_is_found" name="email_is_found" value="{{ email_is_found ? 1 : 0 }}" />

            {% if auth_token_is_valid %}
                <input type="hidden" id="fc_auth_token" name="fc_auth_token" value="{{ fc_auth_token }}" />
                <input type="hidden" id="timestamp" name="timestamp" value="{{ timestamp }}" />
                <input type="hidden" id="fc_customer_id" name="fc_customer_id" value="{{ fc_customer_id }}" />
            {% endif %}

            {# preserve paypal express variables #}
            {% if token != '' and payer_id != '' %}
                <input type="hidden" id="token" name="token" value="{{ token }}" />
                <input type="hidden" id="PayerID" name="PayerID" value="{{ payer_id }}" />
            {% endif %}
            {% for var_name, var_value in hosted_gateway_vars %}
                <input type="hidden" id="{{ var_name }}" name="{{ var_name }}" value="{{ var_value }}" />
            {% endfor %}
        {% endblock required_hidden_fields %}
        </div><!-- data-fc-id="required-hidden-fields" -->


{#
BLOCK: login_register

Possible States:
customer_is_authenticated (bool)
    Default false.
    True if valid SSO token is passed through.
    Docs: http://wiki.foxycart.com/static/redirect/sso
    Source: Serverside.
    we can deal with exact URLs later, but i'm ok with the redirects for now.
    Is not going to change on the client side, right? Maybe this is the difference between a "state" and a config parameter?
    oh… … sec… i see what you're saying. i think it should be documented because it's important, but we should put another note in these docs about it.

email_is_valid
email_is_not_valid
    Default undefined
    Description: Email syntax check.
    Source: Clientside and serverside.

email_is_found
email_is_not_found
    Default undefined
    Description: Email is found in the db (from a previous transaction or if the user was previously created via the API).
    Source: Clientside and serverside.


Ok, so, I think it should go in terms of this:
* Serverside stuff that precedes / determines what clientside "states" are even possible.
* If success state
* Elseif failure state
* Optional: Else default.
And each state that necessarily precedes another state goes first. So email_is_valid has to come before email_is_found. It has to be valid to be found.


#}

<div data-fc-id="block-login-register">
{% block login_register %}
    <fieldset id="fc-email">
        <legend><span class="hidden-xs"></span> {{ config.lang.checkout_email }}</legend>

        {# logic for setting the wrapper class regarding alerts, if one is needed #}
        {% if email_is_checking %}
            {% set message_class = 'has-info' %}
        {% elseif email_is_valid and email_is_found %}
            {% set message_class = 'has-success' %}
        {% elseif not email_is_valid %}
            {% set message_class = 'has-error' %}
        {% else %}
            {% set message_class = '' %}
        {% endif %}

        <div class="form-group {{ message_class }}">
            <div class="col-sm-8 col-sm-offset-3">

        {% if not customer_is_authenticated %}
            {# Not SSO authenticated #}
            <label for="customer_email" class="semantic-only">{{ config.lang.email_email }}</label>
            <input type="email"
                id="customer_email"
                name="customer_email"
                value="{{ customer_email }}"
                placeholder="{{ config.lang.email_email }}"
                autocomplete="off"
                class="form-control"
                data-fc-error-class="invalid"
                {% if is_subscription_cancel %}
                disabled
                {% endif %}
                formnovalidate
                autofocus />
            {% if email_is_valid %}
                {% if is_anonymous == 1 or (has_subscriptions == false and checkout_type == 'guest_only') %}
                {# guest checkout: do nothing #}
                {% else %}
                    {% if email_is_checking %}
                        <div class="alert alert-info">
                            {{ config.lang.checkout_instructions_email_checking }}
                        </div>
                    {% elseif email_is_found %}
                        <div class="alert alert-success" data-fc-messaging-for="customer_email">
                            <p>{{ config.lang.checkout_as_returning_customer|raw }}</p>
                            <div class="input-group">
                                <label for="customer_password" class="semantic-only">{{ config.lang.checkout_password }}</label>
                                <input type="password"
                                    id="customer_password"
                                    name="customer_password"
                                    value="{{ customer_password }}"
                                    placeholder="{{ config.lang.checkout_password }}"
                                    autocomplete="email"
                                    class="form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default" data-fc-id="sign-in" type="button">{{ config.lang.checkout_sign_in|raw }}</button>
                                </span>
                            </div>
                            {% if authentication_is_in_progress %}
                            <div class="alert alert-info">
                                <p>{{ config.lang.checkout_loading|raw }}</p>
                            </div>
                            {% endif %}
                            {% if authentication_is_successful %}
                            <div class="alert alert-success">
                                {% if force_password_reset %}
                                <p>{{ config.lang.checkout_found_customer_force_password_reset|raw }}</p>
                                {% else %}
                                <p>{{ config.lang.checkout_found_customer_info_logged_in|raw }}</p>
                                {% endif %}
                            </div>
                            {% elseif authentication_is_not_successful %}
                            <div class="alert alert-danger">
                                <p>{{ config.lang.checkout_error_incorrect_password|raw }}</p>
                            </div>
                            {% endif %}
                            {% if password_reminded %}
                            <div class="alert alert-info">
                                <p>{{ config.lang.checkout_password_sent_to }} {{ customer_email }} {{ config.lang.checkout_password_sent_check_spam }}</p>
                            </div>
                            {% endif %}
                            {% if password_expired %}
                            <div class="alert alert-danger">
                                <p>{{ config.lang.checkout_error_password_expired }}</p>
                            </div>
                            {% endif %}
                            <ul class="list-inline">
                                <li class="pull-left">
                                    <small class="pull-left"><button data-fc-id="reset-password" type="button" class="btn btn-link">{{ config.lang.checkout_email_my_password|raw }}</button></small>
                                </li>
                                {% if is_updateinfo == false and has_subscriptions == false and checkout_type != 'account_only' %}
                                <li class="pull-right">
                                    <small class="pull-right"><button data-fc-id="checkout-as-guest" type="button" class="btn btn-link">{{ config.lang.checkout_as_guest|raw }}</button></small>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    {% endif %}
                    {# email not found, do nothing #}
                {% endif %}
            {% else %}
                <div class="alert alert-danger">
                {{ config.lang.checkout_error_email|raw }}
                </div>
            {% endif %}
        {% else %}{# customer_is_authenticated #}
            {# Is SSO authenticated, email is readonly #}
            {{ customer_email }}
            {# Why do we need a hidden email field below?
            If we use it for setting the email, it's unsafe. #}
            <input type="hidden" name="customer_email" id="customer_email" value="{{ customer_email }}" />
            {{ config.lang.checkout_sso_already_logged_in|raw }}
        {% endif %}

            </div>
        </div>
    </fieldset>
{% endblock login_register %}
</div><!-- data-fc-id="block-login-register" -->


{% if not is_subscription_cancel %}

    {# SHIPPING ADDRESS ===================================================== #}
    {% if has_shippable_products %}
        <div data-fc-id="block-customer-shipping">
        {% block customer_shipping %}
            {% if not has_multiship %}{# what we want here is if there's no multiship, OR (if there is multiship AND shiptos.length = 1). ie. if it's multiship but there's only 1 shipto, treat it like normal singleship. #}
                {% include "checkout_address_entry.inc.twig" with {'address': shipping_address} %}
                {{ utils.use_different_addresses(use_different_addresses, config.lang) }}
            {% elseif multiship_data|length == 1 %}
                {% include "checkout_address_entry.inc.twig" with {'address': multiship_data[0]} %}
                {{ utils.use_different_addresses(use_different_addresses, config.lang) }}
            {% else %}{# Multiship! #}
                {% for multiship in multiship_data %}
                    {% include 'checkout_address_entry.inc.twig' with {'address': multiship} %}
                    {% if MULTISHIP_PREVIOUSLY_USED_SHIPTOS_EXIST %}
                        {# previously used addresses select box #}
                    {% endif %}
                    {# Subtotal (shipto subtotal + shipping + tax) #}
                {% endfor %}
            {% endif %}
        {% endblock customer_shipping %}
        </div><!-- data-fc-id="block-customer-shipping" -->
    {% endif %}

    {# BILLING ADDRESS ===================================================== #}
    <div data-fc-id="block-customer-billing">
    {% block customer_billing %}
        {% if use_alternate_shipping_address or not has_shippable_products or multiship_data|length > 1 %}
            {% include "checkout_address_entry.inc.twig" with {'address': billing_address} %}
        {% endif %}
    {% endblock customer_billing %}
    </div><!-- data-fc-id="block-customer-billing" -->

    {# SHIPPING METHOD ===================================================== #}
    {% if not has_multiship %}
    <div data-fc-id="block-shipping-results">
        {% if shipping_address.shipping_results|length > 0 %}
        <fieldset data-fc-id="shipping-results">
            <legend><span class="hidden-xs"></span> {{ config.lang.checkout_shipping_method }}</legend>
            {{ utils.shipping_results(shipping_address) }}
        </fieldset>
        {% endif %}
    </div><!-- data-fc-id="block-shipping-results" -->
    {% elseif multiship_data|length == 1 %}
    <div data-fc-id="block-{{ multiship_data[0].prefix }}-results">
        {% if multiship_data[0].shipping_results|length > 0 %}
        <fieldset data-fc-id="shipping-results">
            <legend><span class="hidden-xs"></span> {{ config.lang.checkout_shipping_method }}</legend>
            {{ utils.shipping_results(multiship_data[0]) }}
        </fieldset>
        {% endif %}
    </div><!-- data-fc-id="block-shipto_0-results" -->
    {% endif %}



    {# PAYMENT METHOD ===================================================== #}
    <div data-fc-id="block-payment-method">
    {% block payment_method %}
        {% set payment_method_input_type = config.has_multiple_payment_options or has_saved_cc ? 'radio' : 'hidden' %}
        <fieldset id="fc-payment" data-fc-container="payment">
            <legend><span class="hidden-xs"></span> {{ config.lang.checkout_payment_method }}</legend>

            <i id="fc-icon-lock-large" class="icon-lock hidden-xs hidden-sm"></i>

            {% if config.supports_pay_with_plastic %}

                {% if has_saved_cc %}

                {% set error_string = utils.get_error_string('cc_cvv2_saved',messages.errors) %}
            <div class="form-group{% if error_string %} has-error{% endif %}" data-fc-id="payment-method-plastic-saved-group" >
                <div id="fc-payment-method-plastic-saved" class="fc-payment-method col-md-8 col-md-offset-3">
                    <div class="radio {% if payment_method_type == "plastic_saved" %}active{% endif %}">
                        <label class="label-title">
                            <input type="hidden" name="cc_type" id="cc_type" value="{{ cc_type }}" />
                            <input type="radio"
                                {{ checked(payment_method_type, 'plastic_saved') }}
                                id="fc_payment_method_plastic_saved"
                                name="fc_payment_method"
                                value="plastic_saved"
                                autocomplete="off"/>
                            <!-- TODO: Show saved card logo (Visa/MC/AmEx/etc.) -->
                            {# EVG: Would that be … payment_method_type_brand? or… checkout_cc_number_card_type or something? or what's cc_type doing? Whatever, stick it in here below. #}
                            <span class="fc-payment-method-logo"><img data-fc-id="card_type_img" src="https://cdn.foxycart.com/static/images/payment_logos/visa.png" alt="visa" /></span>
                            <!-- TODO: format cc_number_masked -->
                            {{ config.lang.checkout_use_saved_payment_info|raw }}
                            <!-- TODO: remove this hardcoded masked value. Using to style. -->
                            <span class="fc-payment-method-plastic-saved text-muted" data-fc-id="masked-card">{{ cc_number_masked }}</span>
                            <input type="hidden" name="cc_number_masked" id="cc_number_masked" value="{{ cc_number_masked }}" />
                            <input type="hidden" name="cc_exp_year" id="cc_exp_year" value="{{ cc_exp_year }}" />
                            <input type="hidden" name="cc_exp_month" id="cc_exp_month" value="{{ cc_exp_month }}" />
                        </label>

                        <i class="icon-lock visible-xs visible-sm"></i>

                        {% if payment_method_type == "plastic_saved" %}
                            <div class="form-group">
                                <label for="" class="col-xs-9 control-label text-right">{{ config.lang.checkout_expiration }}</label>
                                <div class="col-xs-3">
                                    <p class="form-control-static text-muted">{{ cc_exp_month }} {{ cc_exp_year }}</p>
                                </div>
                            </div>
                            {% if is_updateinfo == false and ((config.template_config.csc_requirements == "all_cards" and is_uoe == false) or (config.template_config.csc_requirements == "sso_only" and customer_is_authenticated)) %}
                            <div class="form-group">
                                <label class="col-xs-9 control-label text-right" for="cc_cvv2_saved">{{ config.lang.checkout_card_verification_code }} (?)</label>
                                <div class="col-xs-3">
                                    <input type="tel"
                                        id="cc_cvv2_saved"
                                        name="cc_cvv2_saved"
                                        value="{{ cc_cvv2_saved }}"
                                        maxlength="4"
                                        placeholder="{{ config.lang.checkout_csc }}"
                                        autocomplete="off"
                                        class="form-control" />
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                        {% if error_string %}
                        <div class="alert alert-danger">
                            {{ config.lang.checkout_error_verification_code|raw }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
                {% endif %}{# has_saved_cc #}

                {% set cvv2_error_string = utils.get_error_string('cc_cvv2',messages.errors) %}
                {% set cc_number_error_string = utils.get_error_string('cc_number',messages.errors) %}

            <div class="form-group" data-fc-id="fc-payment-method-plastic-new">
                <div id="fc-payment-method-plastic-new" class="fc-payment-method col-md-8 col-md-offset-3">
                    <div class="{% if payment_method_input_type == 'radio' or has_saved_cc %}radio {% if payment_method_type == 'plastic_new' %}active{% endif %}{% endif %}">
                        <label class="label-title">
                            <!-- TODO: need to set the fc_payment_method=plastic for this -->
                            <!-- TODO: What's the payment_method_type doing in this context? Used for hard errors? -->
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'plastic_new') }}
                                id="fc_payment_method_plastic_new"
                                name="fc_payment_method"
                                value="plastic_new"
                                autocomplete="cc-number" />
                        {% for card_type in config.template_config.supported_payment_cards %}
                            <span class="fc-card-type-icon fc-card-type-icon-{{ card_type }}">
                                <img class="fc-{{ card_type }}" src="https://cdn.foxycart.com/static/images/payment_logos/{{ card_type }}.png" alt="{{ card_type }}" />
                            </span>
                        {% endfor %}
                        {{ config.lang.checkout_enter_new_card|raw }}
                        </label>
                        {% if payment_method_type == 'plastic_new' %}
                        <div class="form-group fc-form-group-multiple-inline">
                            <label class="col-xs-3 control-label text-right" for="cc_number">{{ config.lang.checkout_card_number }}</label>
                            <div class="col-xs-8">
                                <input type="tel"
                                    id="cc_number"
                                    name="cc_number"
                                    value="{{ cc_number }}"
                                    maxlength="16"
                                    placeholder="{{ config.lang.checkout_card_number }}"
                                    autocomplete="cc-number"
                                    class="form-control" />
                                <i class="icon-lock visible-xs visible-sm"></i>
                            </div>
                        </div>
                        <div class="form-group fc-form-group-multiple-inline">
                            <label class="col-xs-9 col-sm-3 control-label" for="cc_exp_month">{{ config.lang.checkout_expiration|raw }}</label>
                            <label class="semantic-only" for="cc_exp_year">{{ config.lang.cart_year|raw }}</label>
                            <label class="col-xs-2 visible-xs control-label" for="cc_cvv2">{{ config.lang.checkout_cart_verification_code|raw }} (?)</label>
                            {% set field_name = 'cc_exp_month' %}
                            {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                            <div id="fc-payment-method-plastic-expires-month" class="col-xs-5 col-sm-3 {% if error_string %}has-error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="has-error">
                                <select class="form-control" name="cc_exp_month" id="cc_exp_month" autocomplete="cc-exp-month">
                                    <option value="">{{ config.lang.cart_month|raw }}</option>
                                    {% for month in cc_expiration_months %}
                                    <option value="{{ month.value }}" {{ selected(cc_exp_month, month.value) }}>
                                        {{ month.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% set field_name = 'cc_exp_year' %}
                            {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                            <div id="fc-payment-method-plastic-expires-year" class="col-xs-4 col-sm-3 {% if error_string %}has-error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="has-error">
                                <select class="form-control" name="cc_exp_year" id="cc_exp_year" autocomplete="cc-exp-year">
                                    <option value="">{{ config.lang.cart_year|raw }}</option>
                                    {% for year in cc_expiration_years %}
                                    <option value="{{ year }}" {{ selected(cc_exp_year, year) }}>
                                        {{ year }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div id="fc-payment-method-plastic-csc" class="col-xs-2 col-sm-2">
                                <input type="tel"
                                    id="cc_cvv2"
                                    name="cc_cvv2"
                                    value="{{ cc_cvv2 }}"
                                    maxlength="4"
                                    placeholder="{{ config.lang.checkout_csc }}"
                                    autocomplete="cc-csc"
                                    class="form-control"
                                     />
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="alert alert-danger hide {{ cvv2_error_string ? 'show' : '' }}" data-fc-error-for="cc_cvv2" data-fc-error-class="show">
                        {{ config.lang.checkout_error_verification_code|raw }}
                    </div>
                    <div class="alert alert-danger hide {{ cc_number_error_string ? 'show' : '' }}" data-fc-error-for="cc_number" data-fc-error-class="show">
                        {{ config.lang.checkout_error_card_number|raw }}
                    </div>
                </div>
            </div>
            {% endif %}{# config.supports_pay_with_plastic #}

            {% if show_paypal_express_payment_option and not is_updateinfo %}
            <div class="form-group">
                <div id="fc-payment-method-paypal" class="fc-payment-method col-md-8 col-md-offset-3">
                    <div class="{% if payment_method_input_type == 'radio' or has_saved_cc %}radio {% if payment_method_type == 'paypal' %}active{% endif %}{% endif %}">
                        <label class="label-title">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'paypal') }}
                                id="fc_payment_method_paypal"
                                name="fc_payment_method"
                                value="paypal"
                                autocomplete="off" />
                            {{ config.lang.checkout_pay_with_paypal|raw }}
                        </label>
                        {% if payment_method_type == 'paypal' %}
                        <div class="form-group fc-form-group-multiple-inline">
                            {{ config.lang.checkout_payment_method_paypal }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}{# show_paypal_express_payment_option and not is_updateinfo #}

            {% if not is_updateinfo %}
                {% for hosted_gateway in hosted_payment_gateways %}
            <div class="form-group">
                <div id="fc-payment-method-{{ hosted_gateway.type }}" class="fc-payment-method col-md-8 col-md-offset-3">
                    <div class="{% if payment_method_input_type == 'radio' or has_saved_cc %}radio {% if payment_method_type == hosted_gateway.type %}active{% endif %}{% endif %}">
                        <label class="label-title">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, hosted_gateway.type) }}
                                id="fc_payment_method_{{ hosted_gateway.type }}"
                                name="fc_payment_method"
                                value="{{ hosted_gateway.type }}"
                                autocomplete="off" />
                            {{ hosted_gateway.lang_pay_with|raw }}
                        </label>
                        {% if payment_method_type == hosted_gateway.type %}
                        <div class="form-group fc-form-group-multiple-inline">
                            {{ hosted_gateway.lang_payment_method }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
                {% endfor %}
            {% endif %}{# not is_updateinfo #}

            {% if config.supports_purchase_order and not is_updateinfo %}
            <div class="form-group">
                <div id="fc-payment-method-purchase-order" class="fc-payment-method col-md-8 col-md-offset-3">
                    <div class="{% if payment_method_input_type == 'radio' %}radio {% if payment_method_type == 'purchase_order' %}active{% endif %}{% endif %}">
                        <label class="label-title">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'purchase_order') }}
                                id="fc_payment_method_purchase_order"
                                name="fc_payment_method"
                                value="purchase_order"
                                autocomplete="off"/>
                            {{ config.lang.checkout_pay_with_purchase_order|raw }}
                        </label>
                        {% if payment_method_type == 'purchase_order' %}
                        <div class="form-group">
                            <label class="col-xs-3 control-label text-right" for="purchase_order">{{ config.lang.checkout_purchase_order_number }}</label>
                            <div class="col-xs-8">
                                <input type="text"
                                    id="purchase_order"
                                    name="purchase_order"
                                    value="{{ purchase_order }}"
                                    maxlength="30"
                                    placeholder=""
                                    autocomplete="off"
                                    class="form-control"/>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}{# config.supports_purchase_order and not is_updateinfo #}
        </fieldset>
    {% endblock payment_method %}
    </div><!-- data-fc-id="block-payment-method" -->


    {# ADDITIONAL FIELDS ===================================================== #}
    <div data-fc-id="block-additional-fields">
    {% block additional_fields %}
        <fieldset id="fc-additional-fields">
            <legend><span class="hidden-xs"></span> {{ config.lang.checkout_almost_done }}</legend>
            {# TODO: other config options like TOS, email subscribe, etc. #}

            {% if config.template_config.tos_checkbox_settings.usage != "none" %}
            {# ToDo: Needs to take into account if the field is required or optional #}
            <div class="form-group">
                {% set field_name = 'tos_agreement' %}
                {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                <div class="col-md-8 col-md-offset-3 {% if error_string %}has-error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="has-error">
                    <div class="checkbox">
                        <label class="label-title label-title-passive">
                            <input type="checkbox"
                                id="tos_agreement"
                                name="tos_agreement"
                                value="1"
                                {{ checked(config.template_config.tos_checkbox_settings.initial_state == "checked") }} />
                            {{ config.lang.checkout_tos|replace({ '#':(config.template_config.tos_checkbox_settings.url) })|raw }}
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if config.template_config.newsletter_subscribe.usage != "none" %}
            <div class="form-group">
                <div class="col-md-8 col-md-offset-3">
                    <div class="checkbox">
                        <label class="label-title label-title-passive">
                            <input type="checkbox"
                                name="newsletter_subscribe"
                                value="1" />
                            {{ config.lang.checkout_newsletter_subscribe|raw }}
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if (anonymous_checkout_selected == false) and (force_password_reset or ((is_updateinfo == false) and (email_is_found == false) and (has_subscriptions or (checkout_type != "guest_only")))) %}
            {% set error_string = utils.get_error_string('new_customer_password',messages.errors) %}
            <div class="form-group" data-fc-container="account_creation">
                <div class="col-md-8 col-md-offset-3">
                    <div class="checkbox {% if has_subscriptions or create_account or force_password_reset %}active{% endif %}">
                        {% if not has_subscriptions or force_password_reset %}
                        <label data-fc-id="account_creation-label" class="label-title label-title-passive">
                            <input
                                type="checkbox"
                                name="create_account"
                                id="create_account"
                                value="1"
                                {% if create_account or force_password_reset %}checked{% endif %}
                                {% if force_password_reset %}disabled{% endif %}
                                />
                            {{ config.lang.checkout_create_an_account }}
                        </label>
                        {% endif %}
                        {% if has_subscriptions or create_account or force_password_reset %}
                        <div class="form-group">
                            <p>{{ config.lang.checkout_no_account_enter_password }}</p>
                            {% if force_password_reset %}
                                {# put some text here...? #}
                            {% endif %}
                            <input type="password"
                                id="new_customer_password"
                                name="new_customer_password"
                                minlength="8"
                                placeholder="{{ config.lang.checkout_password }}"
                                autocomplete="on"
                                class="form-control"
                                value="{{ new_customer_password }}"
                                />
                        </div>
                        {% endif %}
                    </div>
                    {% if error_string %}
                    <div class="alert alert-danger">
                        <div class="">{{ config.lang.checkout_error_password }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}


            <div id="fc-submit" class="form-group fc-form-group-multiple-inline">
                {# TODO: The context here needs to work serverside on pageload too. #}
                {% if payment_method_type in ["plastic_new", "plastic_saved"] %}
                    {% if config.template_config.use_checkout_confirmation_window.usage == "required" %}
                        {% set checkout_button_text = config.lang.checkout_complete_your_purchase %}
                        {% set checkout_button_helper_text = config.lang.checkout_payment_confirmation %}
                    {% else %}
                        {% set checkout_button_text = config.lang.checkout_confirm_your_purchase %}
                    {% endif %}
                {% else %}
                    {% set checkout_button_helper_text = config.lang['checkout_payment_method_' ~ payment_method_type] %}
                    {% set checkout_button_text = config.lang.checkout_complete_your_purchase %}
                {% endif %}
                {% if is_updateinfo %}
                    {% set checkout_button_text = config.lang.checkout_update_my_information %}
                    {% set checkout_button_helper_text = '' %}
                {% endif %}
                {% if is_subscription_modification %}
                    {% set checkout_button_text = config.lang.checkout_update_my_subscription %}
                    {% set checkout_button_helper_text = '' %}
                {% endif %}
                <div class="col-sm-5 col-md-4 col-sm-offset-3">
                    <button class="btn btn-primary btn-large btn-block">{{ checkout_button_text }}</button>
                </div>
                {% if checkout_button_helper_text %}
                <div class="col-sm-4 col-md-5">
                    <p class="text-muted">
                        <small>{{ checkout_button_helper_text }}</small>
                    </p>
                </div>
                {% endif %}
            </div>
        </fieldset>
    {% endblock additional_fields %}
    </div><!-- data-fc-id="block-additional-fields" -->

{% else %}{# is_subscription_cancel #}

    <div data-fc-id="block-subscription-cancel">
    {% block subscription_cancel %}
        <fieldset id="fc-subscription-cancel">
            <legend><span class="hidden-xs"></span> {{ config.lang.checkout_almost_done }}</legend>

            <div id="fc-submit" class="form-group fc-form-group-multiple-inline">
                <div class="col-sm-4 col-sm-offset-3">
                    <button class="btn btn-primary btn-large btn-block">{{ config.lang.checkout_cancel_my_subscription }}</button>
                </div>
                {# TODO: Dynamically change this text based on the authentication state? #}
                <div class="col-sm-5">
                    <p class="text-muted">
                        <small>{{ config.lang.checkout_subscription_cancel_helper_text }}</small>
                    </p>
                </div>
            </div>
        </fieldset>
    {% endblock subscription_cancel %}
    </div><!-- data-fc-id="block-subscription-cancel" -->

{% endif %}



    </form>
    </div>{# #fc-main #}

</div>{# #fc-checkout-container #}
</div>{# .container #}
{# END CHECKOUT TWIG TEMPLATE #}
</div><!-- data-fc-id="checkout" -->
</div>
{% endblock checkout %}
